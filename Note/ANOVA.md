# ANOVA

## 两种典型错误

### 第一类错误（Type I Error）

**定义**：当原假设 $H_0$ 为真时，错误地拒绝了原假设。

**例子**：假设一个药物无效，但实验结果错误地显示药物有效。这时，我们犯了第一类错误。

**符号**：通常用 $\alpha$  表示，称为显著性水平。例如，$\alpha = 0.05$  表示有5%的概率犯第一类错误。

### 第二类错误（Type II Error）

**定义**：当备择假设 $H_1$ 为真时，错误地未能拒绝原假设。

**例子**：假设一个药物有效，但实验结果错误地显示药物无效。这时，我们犯了第二类错误。

**符号**：通常用 $\beta$ 表示。

### 例子说明

假设我们进行一个药物试验，目的是检测药物A是否有效。

- **原假设 ( $H_0$）**：药物A无效。
- **备择假设（$H_1$）**：药物A有效。

**第一类错误的例子**：实验结果显示药物A有效，但实际上药物A无效 $\alpha$ 。例如，我们设定的显著性水平为0.05，这意味着有5%的概率会出现这种错误。

**第二类错误的例子**：实验结果显示药物A无效，但实际上药物A有效 $\beta$ 。假设我们设定的功效为0.80，这意味着有20%的概率会出现这种错误。

### 总结

- **第一类错误（$\alpha$）**：错误地认为药物有效。
- **第二类错误（$\beta$）**：错误地认为药物无效。

通过理解这两种错误，我们可以更好地设计实验，并理解结果的可靠性和局限性。

---

## 非参数检验

#### 介绍

非参数检验是一类不依赖于数据分布假设的统计方法，适用于数据不满足正态分布或存在异常值的情况。

#### 适用条件

1. **分布无关**：不需要数据服从特定分布。
2. **适用于小样本**：特别适用于样本量较小的数据集。
3. **处理异常值**：对异常值不敏感。

#### 用途

- **Mann-Whitney U检验**：用于比较两组独立样本的中位数差异。
- **Kruskal-Wallis检验**：用于比较多组独立样本的中位数差异。
- **Wilcoxon符号秩检验**：用于比较配对样本的中位数差异。

### 总结

ANOVA在比较多个组均值时非常有用，特别是在满足其假设条件下。非参数检验则为数据不满足这些假设的情况提供了有效的替代方法。ANOVA的详细步骤和用途在本PPT中得到了充分的说明，适用于分析实验数据和观察数据中不同组之间的差异。

## t 检验和 Wilcoxon 秩检验的比较

在 t 检验和 Mann-Whitney 检验之间进行选择的关键因素是备择假设 ($H_1$)下的统计功效

- 对于对称数据（包括正态分布），t 检验比 Mann-Whitney 检验稍微强一些

- 如果数据偏斜，则 Mann-Whitney 检验可能比 t 检验更强大

- t 检验 拒绝 $H_0$ 仅在组均值不同的情况下

- Mann-Whitney 检验可以因为组均值差异以外的原因否定 $H_0$ 
  
  <img title="" src="file:///C:/Users/WIN10/Desktop/course/Note/imgs/Mann.png" alt="" data-align="center">

$$
p(t.test) = 0.8982921 \quad   p(wilcoxon) = 0.004800793
$$

p 值过小，拒绝原假设 $H_0$

如上图所示，Wilcoxon 秩检验会拒绝<font color=#D5584B>来自不同的分布</font>，即使均值相同，而 t 检验做不到。

---

### 统计功效（Power）

统计功效（Power）是指在假设检验中，正确拒绝原假设（即当实际存在效应时，检验能正确检测出这种效应）的概率。

#### 公式表示

统计功效可以表示为

$$
\text{Power} = 1 - \beta
$$

其中，$\beta$ 是第二类错误的概率，即实际存在效应却未能拒绝原假设的概率。

#### 影响因素

1. **效应大小（Effect Size）**：
   
   $$
   d = \frac{|\mu_1 - \mu_2|}{\sigma}
   $$
   
   其中，$\mu_1$ 和 $\mu_2$ 是两组均值，$\sigma$ 是标准差。

2. **样本量（Sample Size）**：
   样本量越大，标准误差越小，功效越高。

3. **显著性水平（Significance Level, $\alpha$）**：
   通常设定为0.05（5%），表示第一类错误的概率。

4. **数据变异性（Variance）**：
   数据变异性越小，功效越高。

#### 示例

假设进行一个新药物试验，目标是检测新药物组和安慰剂组之间的差异。

- **效应大小**：新药物组平均症状减轻10分，安慰剂组平均症状减轻5分，标准差为8分。
  
  $$
  d = \frac{|10 - 5|}{8} = 0.625
  $$

- **样本量**：每组30名参与者。

根据以上参数，可以使用功效计算公式或表格查找相应的功效值。假设功效值计算为0.80（80%），这意味着在此样本量和效应大小下，我们有80%的概率正确拒绝原假设，检测出新药物的效果。

### 总结

统计功效是确保实验设计合理性的重要指标。较高的统计功效能增加发现实际效应的概率，进而提高研究结果的可靠性。

---

## 方差分析 (ANOVA)

#### 介绍

方差分析（Analysis of Variance, ANOVA）是一种用于比较三个或更多样本组的均值是否存在显著差异的统计方法。通过比较组间变异与组内变异，ANOVA帮助确定组间差异的显著性。

#### 适用条件

1. **独立性假设**：样本数据应相互独立。
2. **正态性假设**：各组数据应近似服从正态分布。
3. **方差齐性假设**：各组数据的方差应相等。

#### 用途

- **单因素ANOVA**：比较<font color=#D5584B>多个组的均值</font>，确定是否存在显著差异。
- **双因素ANOVA**：分析两个因素对响应变量的影响，并考虑交互作用。
- **重复测量ANOVA**：处理同一组被试在不同条件下的重复测量数据。

### 初始假设

$$
H_0: \sigma_x^2 = \sigma_y^2\quad H_1: \sigma_x^2\neq\sigma_y^2
$$

- **F 检验**是两个方差估计值的比率

- **Bartlett 检验** 可以检验许多组中方差的相等性

        上述两个检验假定为正态

- **Levene 检验**是针对许多群体的检验，它不太依赖于正常性假设

- **Brown-Forsythe 检验**类似于 Levene's 检验，但对分布假设的鲁棒性更强

        还提供非参数测试：**Fligner-Killeen 检验**、**Ansari-Bradley 检验**和 **情绪检验**

---

## One-Way ANOVA（单因素方差分析）

### 介绍

One-Way ANOVA用于比较三个或更多组的均值，判断这些组的均值是否存在显著差异。单因素方差分析只考虑一个因素对响应变量的影响。

单因素方差分析（One-Way ANOVA）适用条件、前提条件、适用情况和目的如下：

### 适用条件和前提条件：

1. **独立性**：样本数据应该是独立采样的，即各组之间的数据点不会相互影响。

2. **正态性**：各组数据应当服从正态分布。特别是在样本量较小的情况下，正态性更为重要。

3. **方差齐性**：各组数据的方差应当大致相等。方差不齐的情况下，ANOVA的结果可能不可靠。

#### 适用情况：

- **多组数据比较**：适用于比较三个或更多组之间的平均值是否存在显著差异。

- **实验设计**：常用于实验设计中，比较不同处理（组）对观测变量的影响是否显著。

#### 目的：

- **检验均值差异的显著性**：判断多个组的均值是否有显著差异，即是否有一个或多个组的均值与其他组有所不同。

- **解释组间变异性**：分解总体方差为组间变异和组内变异，帮助理解各组均值之间的差异来源。

<img title="" src="file:///C:/Users/WIN10/Desktop/course/Note/imgs/ANOVA1.png" alt="" data-align="center" width="394">

$$
X\sim N(0, \sigma^2),\quad Y\sim N(0, \sigma_i^2), \quad Z\sim \Gamma(1, 1/10)
$$

共5组，每组样本量 $n=10$，可见等样本量下，<font color=#D5584B>等方差性</font>和<font color=#D5584B>正态性</font>条件可以适当放宽

<img title="" src="file:///C:/Users/WIN10/Desktop/course/Note/imgs/ANOVA2.png" alt="" data-align="center" width="408">

仍为5组，每组样本量不均衡 $n=2,6,10,12,20$，可见<font color=#D5584B>不同组样本量的平衡与否</font>会严重影响 ANOVA 的效果。

### 理论形式

1. **总平方和（SST）**：
   
   $$
   \text{SST} = \sum_{i=1}^{N} (X_i - \bar{X})^2
   $$
   
   其中，$X_i$ 是所有观测值，$\bar{X}$ 是总体均值。

2. **组间平方和（SSB）**：
   
   $$
   \text{SSB} = \sum_{j=1}^{k} n_j (\bar{X}_j - \bar{X})^2
   $$
   
   其中， $\bar{X}_j$  是第 $j$ 组的均值， $n_j$ 是第 $j$ 组的样本数。

3. **组内平方和（SSW）**：
   
   $$
   \text{SSW} = \sum_{j=1}^{k} \sum_{i=1}^{n_j} (X_{ij} - \bar{X}_j)^2
   $$
   
   其中， $X_{ij}$ 是第 $j$ 组的第 $i$ 个观测值。易证得
   
   $$
   \text{SSW} = \text{SST} - \text{SSB}
   $$

4. **F值**：
   
   $$
   F = \frac{\text{MSB}}{\text{MSW}}
   $$
   
   其中，$\text{MSB} = \frac{\text{SSB}}{k-1}$ 和 $\text{MSW} = \frac{\text{SSW}}{n-k}$ 

### 例子

| Unit ($j$) / Group ($i$) | 1   | 2   | 3   |
|:------------------------:|:---:|:---:|:---:|
| 1                        | 1   | 3   | 5   |
| 2                        | 2   | 4   | 6   |
| 3                        | 3   | 5   | 7   |
| 4                        | 4   | 6   | 8   |
| Mean                     | 2.5 | 4.5 | 6.5 |

### 步骤

1. **计算总体均值（Grand Mean）**：
   
   $$
   \bar{X} = \frac{1 + 2 + 3 + 4 + 3 + 4 + 5 + 6 + 5 + 6 + 7 + 8}{12} = \frac{54}{12} = 4.5
   $$

2. **计算总平方和（Total Sum of Squares, SST）**：
   
   $$
   \text{SST} = \sum_{i=1}^{k} \sum_{j=1}^{n_i} (X_{ij} - \bar{X})^2
   $$
   
   $$
   \text{SST} = 12.25 + 6.25 + 2.25 + 0.25 + 2.25 + 0.25 + 0.25 + 2.25 + 0.25 + 2.25 + 6.25 + 12.25 = 47.5
   $$

3. **计算组间平方和（Between-group Sum of Squares, SSB）**：
   
   $$
   \text{SSB} = \sum_{i=1}^{k} n_i (\bar{X}_i - \bar{X})^2
   $$
   
   $$
   \text{SSB} = 4(2.5 - 4.5)^2 + 4(4.5 - 4.5)^2 + 4(6.5 - 4.5)^2
   $$
   
   $$
   \text{SSB} = 4(-2)^2 + 4(0)^2 + 4(2)^2
   $$
   
   $$
   \text{SSB} = 4(4) + 4(0) + 4(4) = 16 + 0 + 16 = 32
   $$

4. **计算组内平方和（Within-group Sum of Squares, SSW）**：
   
   $$
   \text{SSW} = \text{SST} - \text{SSB} = 47.5 - 32 = 15.5
   $$

5. **计算均方（Mean Squares）**：
   
   - 组间均方（MSB）：
     
     $$
     \text{MSB} = \frac{\text{SSB}}{k-1} = \frac{32}{3-1} = \frac{32}{2} = 16
     $$
   
   - 组内均方（MSW）：
     
     $$
     \text{MSW} = \frac{\text{SSW}}{N-k} = \frac{15.5}{12-3} = \frac{15.5}{9} \approx 1.72
     $$

6. **计算F值**：
   
   $$
   F = \frac{\text{MSB}}{\text{MSW}} = \frac{16}{1.72} \approx 9.3
   $$

7. **自由度**
   
   统计学中用来描述独立信息量的概念。在单因素方差分析（One-Way ANOVA）中，自由度的计算如下：
   
   1. **组间自由度（Between-group Degrees of Freedom, $\text{df}_{\text{between}}$ ）**：
      
      $$
      \text{df}_{\text{between}} = k - 1
      $$
      
      其中，$K$ 是组的数量。在此例中，$k = 3$，所以：
      
      $$
      \text{df}_{\text{between}} = 3 - 1 = 2
      $$
   
   2. **组内自由度（Within-group Degrees of Freedom, $\text{df}_{\text{within}}$ ）**：
      
      $$
      \text{df}_{\text{within}} = N - k
      $$
      
      其中，N 是总的观测值数量。在此例中，N = 12 ，所以：
      
      $$
      \text{df}_{\text{within}} = 12 - 3 = 9
      $$
   
   3. **总自由度（Total Degrees of Freedom,$\text{df}_{\text{total}}$）**：
      
      $$
      \text{df}_{\text{total}} = N - 1
      $$
      
      在此例中：
      
      $$
      \text{df}_{\text{total}} = 12 - 1 = 11
      $$
   
   总结：
   
   - 组间自由度：2
   - 组内自由度：9
   - 总自由度：11

8. **进行F检验**：
   
   - 查找F分布表，确定对应自由度（$df_1 = 2$，$df_2 = 9$）下的临界值。
   - 如果计算出的F值<font color=#D5584B>大于</font>表中的临界值，则<font color=#D5584B>拒绝原假设</font>，认为组间均值有<font color=#D5584B>显著差异</font>。

### 结论

通过计算出的F值，可以判断不同组的均值是否存在显著差异。在此例子中，F值为9.3，如果大于临界值，则说明组间均值有显著差异。

---

## ANOVA 和 t 检验的关系

具有 2 个组的单因素方差分析等效于两个样本 t 检验

### 等效性说明

在只有两个组的情况下，单因素方差分析的F值可以与t检验的t值相关联。具体来说：

1. **F值的计算**：
   
   $$
   F=\frac{MSB}{MSW}​
   $$

2. **t值的计算**：
   
   $$
   t=\frac{\bar{y}_1 - \bar{y}_2}{\sqrt{\frac{(n_1-1)s_1^2+(n_2-1)s_2^2}{n_1+n_2-2}(\frac{1}{n_1}+\frac{1}{n_2}) }}
   $$
   
   $\bar{y_1}, \bar{y_2}$ 为两个样本的均值，$s_1, s_2$ 为两样本方差，$n_1, n_2$ 为两样本量。

3. 对于两个样本的t检验，自由度是 $n1​+n2​−2$。F值与t值之间的关系是

$$
F = t^2
$$

        这表示F值等于t值的平方。

### 证明：

### 推导 F 值和 t 值的关系

我们可以通过以下步骤推导 F 值和 t 值之间的关系：

1. **计算组间平方和（SSB）**：
   在两个组的情况下，组间平方和 \(SSB\) 可以用以下公式计算：
   
   $$
   SSB = n_1 (\bar{y}_1 - \bar{y})^2 + n_2 (\bar{y}_2 - \bar{y})^2
   $$
   
   其中，$\bar{y}$ 是总均值：
   
   $$
   \bar{y} = \frac{n_1 \bar{y}_1 + n_2 \bar{y}_2}{n_1 + n_2}
   $$

2. **计算组内平方和（SSW）**：
   
   $$
   SSW = (n_1 - 1) s_1^2 + (n_2 - 1) s_2^2
   $$

3. **计算均方**：
   
   - 组间均方（MSB）：
     $
     $
     
     $$
     MSB = \frac{SSB}{df_{between}} = \frac{SSB}{1}
     $$
     
     在两个组的情况下，自由度 $df_{between}$ 是 1。
   
   - 组内均方（MSW）：
     
     $$
     MSW = \frac{SSW}{df_{within}} = \frac{SSW}{n_1 + n_2 - 2}
     $$
   
   - 在两个组的情况下，自由度 $df_{within}=n_1 + n_2 - 2$ 

4. **推导 F 值**：
   将 MSB 和 MSW 代入 F 值的公式：
   
   $$
   F = \frac{MSB}{MSW}
   $$

5. **用 t 值表示**：
   通过 t 统计量的平方来表示：
   
   $$
   t^2 = \left( \frac{\bar{y}_1 - \bar{y}_2}{\sqrt{\frac{(n_1-1)s_1^2+(n_2-1)s_2^2}{n_1+n_2-2}(\frac{1}{n_1}+\frac{1}{n_2}) }} \right)^2
   $$

6. **计算 MSB**：
   
   $$
   MSB = \frac{SSB}{1} = \frac{n_1 (\bar{y}_1 - \bar{y})^2 + n_2 (\bar{y}_2 - \bar{y})^2}{1}
   $$
   
   其中：
   
   $$
   \bar{y} = \frac{n_1 \bar{y}_1 + n_2 \bar{y}_2}{n_1 + n_2}
   $$

7. **计算 MSW**：
   
   $$
   MSW = \frac{SSW}{n_1 + n_2 - 2}
   $$

8. **将 MSB 和 MSW 代入 F 值公式**：
   $
   $
   
   $$
   F = \frac{MSB}{MSW}
   $$

9. **证明 F 值等于 t 值的平方**：
   通过标准化的均方和平方和关系：

$$
F = \frac{\frac{n_1 n_2}{n_1+n_2}(\bar{y}_1 - \bar{y}_2)^2}{(\frac{(n_1 - 1)s_1^2 + (n_2 - 1)s_2^2}{n_1 + n_2 - 2})}=t^2
$$

由于 t 值的分母正是组内均方的平方根，F 值正是 t 值的平方。

因此，对于只有两个组的情况，F 值等于 t 值的平方。希望这个推导过程能够清楚地解释它们之间的关系！

4. **自由度**：
- 对于ANOVA中的F值，自由度是 $df_{between}​=1$（因为只有两个组）。
- 对于t检验，自由度是 $df=n_1​+n_2​−2$ 

因此，在只有两个组的情况下，单因素方差分析和两个样本 t 检验在统计计算上是等效的，因为F值可以通过t值的平方得到。这表明，两者的检验结果是一致的。

---

# 高级 ANOVA 分析

## 分析结果

### 问题： 分析 3 种鸢尾花物种的萼片长度的关系

<img title="" src="file:///C:/Users/WIN10/Desktop/course/Note/imgs/species.png" alt="" data-align="center" width="492">

Response = Sepal Length (萼片长度)

|               | Df  | Sum Sq | Mean Sq | F value | Pr(>F)    |
|:-------------:|:---:|:------:|:-------:|:-------:|:---------:|
| **Species**   | 2   | 14.504 | 7.2520  | 36.422  | 2.151e-08 |
| **Residuals** | 27  | 5.376  | 0.1991  |         |           |

### 结果解释

在 ANOVA（方差分析）检验中，Sum Sq（总平方和）和 Mean Sq（均方）是重要的统计量，它们用于评估不同组之间的变异性。具体来说：

1. **Sum Sq（总平方和）**：
   
   - **Species**（组间平方和）：表示不同物种之间的变异性。计算方法是各组均值与总体均值之间的平方和，乘以各组的样本数量，然后将所有组的结果相加。
     
     $$
     \text{SSB} = \sum_{i=1}^{k} n_i (\bar{X}_i - \bar{X})^2
     $$
   - **Residuals**（组内平方和）：表示同一物种内部的变异性。计算方法是每个数据点与其所属组的均值之间的平方和，然后将所有数据点的结果相加。
     
     $$
     \text{SSW} = \sum_{j=1}^{k} \sum_{i=1}^{n_j} (X_{ij} - \bar{X}_j)^2
     $$

2. **Mean Sq（均方）**：
   
   - **Species**（组间均方）：组间平方和除以组间的自由度（自由度等于组数减一）。
     
     $$
     \text{MSB} = \frac{\text{SSB}}{k-1}
     $$
   - **Residuals**（组内均方）：组内平方和除以组内的自由度（自由度等于总样本数减去组数）。
     
     $$
     MSW = \frac{SSW}{df_{within}}=\frac{SSW}{N-k}
     $$

3. **F value (F 值)：**
   
   $$
   F = \frac{MSB}{MSW}
   $$

4. **Pr(>F) (p 值)：**
   
   - **小 p 值**（通常小于 0.05）：表示数据与零假设不一致，支持拒绝零假设。
   
   - **大 p 值**（通常大于 0.05）：表示数据与零假设一致，未能提供足够的证据来拒绝零假设。

### 事后检验（Posthoc tests）

| Compare                | Diff | SE  | T-stat |
|:----------------------:|:----:|:---:|:------:|
| versicolor - setosa    | 0.94 | 0.2 | 4.71   |
| virginica - setosa     | 1.70 | 0.2 | 8.52   |
| virginica - versicolor | 0.76 | 0.2 | 3.81   |

如果我们查看任一模型中各组的成对比较，结果是相同的

#### 1. 参数解释

- **Diff：** 均值的差异。

- **SE：** 标准误（用于估计均值差异的精确度）

- **T-stat：** T 统计量，t 检验中的统计量。

#### 2. **计算 p 值（Compute p-values）**：

每个成对比较都有一个相应的 p 值，用于判断这些差异是否显著。然而，在进行多次比较时，需要对 p 值进行调整，以控制假阳性率（即错误地认为存在显著差异的概率）。

#### 3. **多重比较调整（Multiple Comparisons Adjustment）**：

随着成对比较数量的增加，调整的必要性也增加。这是因为每次比较都会增加犯第一类错误（即拒绝真零假设的错误）的风险。

### 调整方法

常用的多重比较调整方法包括：

1. **Bonferroni 校正**：将显著性水平 $α$ 除以比较的次数。例如，如果有 3 次比较，显著性水平 $α = 0.05$，则每次比较的临界值为 $0.05/3 ≈ 0.017$。
2. **Holm 校正**：一种改进的 Bonferroni 方法，调整每个 $p$ 值，同时控制家族错误率（family-wise error rate）。
3. **Tukey's HSD**：适用于均匀设计，调整比较之间的差异。

---

## 带有阻断因子的ANOVA

### 1. **ANOVA中的多个因子**：

ANOVA模型可以包含多个因子。当某些因子不是研究的主要对象时，它们被称为阻断因子（blocking factors）。这些阻断因子用于控制其他可能影响实验结果的误差来源，从而更准确地检测感兴趣的主要因子的效应。

### 2. **阻断因子的作用**：

阻断因子主要用于控制其他误差来源，这些误差如果不加以控制，可能会掩盖主要因子的显著效应。例如，在农业试验中，地块的差异可能影响作物的生长情况，将地块作为阻断因子可以控制这种影响，从而更好地检测肥料的效应。

### 3. **模型构建**：

假设我们有一个连续响应变量  $Y$，一个主要因子 $T$ 具有$I$个水平，一个阻断因子 $B$ 具有$J$个水平，模型如下：

$$
Y_{ijk}
$$

- **解释**：
  - $Y_{ijk}$ 表示在第 $ i$ 个主要因子水平，第 $j$ 个阻断因子水平，第 $k$ 次试验中的响应值。
  - 假设 $Y_{ijk}$ 是独立的，并服从正态分布，即 $Y_{ijk} \sim N(\mu_{ij}, \sigma^2)$

### 4. **均值模型**：

模型中的均值 $\mu_{ij}$ 可以表示为：

$$
\mu_{ij} = \mu + \tau_i + \beta_j
$$

- **解释**：
  - $ \mu$ 是总体均值。
  - $\tau_i $ 是主要因子 $ T $ 在第 $ i $ 个水平上的效应。
  - $\beta_j$ 是阻断因子 $B$ 在第 $j$ 个水平上的效应。

### 5. **假设检验**：

假设检验的目标是检验主要因子 $T$ 的效应，即：

- **零假设（$H_0$）**：所有主要因子的效应 $\tau_i = 0$，即 $\tau_1 = \tau_2 = \ldots = \tau_I = 0 $
- **备择假设（$ H_1$）**：至少有一个主要因子的效应 $\tau_i \neq 0$

### 例子： 学生的睡眠数据

数据显示了两种药物（group）对额外睡眠时间的影响，阻断变量为（ID）

| Variable  | Df  | Sum Sq | Mean Sq | F value | Pr(>F)  |
|:---------:|:---:|:------:|:-------:|:-------:|:-------:|
| group     | 1   | 12.48  | 12.482  | 16.501  | 0.00283 |
| ID        | 9   | 58.08  | 6.453   | 8.531   | 0.00190 |
| Residuals | 9   | 6.81   | 0.756   |         |         |

如果我们忽略 ID，那么我们看不到对组的显着影响

| Variable  | Df  | Sum Sq | Mean Sq | F value | Pr(>F) |
|:---------:|:---:|:------:|:-------:|:-------:|:------:|
| group     | 1   | 12.48  | 12.482  | 3.463   | 0.0792 |
| Residuals | 18  | 64.89  | 3.605   |         |        |

#### 现象解释：

对应不同分层，无阻断变量的实验里，只有两个变量作为方差来源，组间（group）与组内（Residuals）

而有阻断变量的实验中，有三个变量，除了不同药物分组了，在相同药物的组内还有一次分组（ID），考虑了受试者的个体差异，保证相同组内的情况大体相同且可控。这种情况就可以对多变量进行 ANOVA 分析，得到更加可靠的结论。

- **带有阻断因子的模型**：
  
  - 当考虑受试者的个体差异时，药物组的效应是显著的（p = 0.00283）。
  - 受试者（ID）之间的差异也显著（p = 0.00190），表明个体差异在额外睡眠时间中起重要作用。

- **忽略阻断因子的模型**：
  
  - 如果忽略受试者的个体差异，药物组的效应变得不显著（p = 0.0792），说明受试者间的个体差异掩盖了药物的实际效应。

---

## 双因素方差分析（Two-Way ANOVA）

### 基本概念

- **两因素方差分析与阻断设计相似，但不同的是**：在两因素方差分析中，两个因子都是研究的重点，且可能存在交互作用。
- **符号说明**：
  - $ Y $ 是连续响应变量。
  - $T $ 是第一个因子，具有 $ K$ 个水平。
  - $B $ 是第二个因子，具有 $J$ 个水平。

### 基本框架和假设检验步骤：

1. **模型构建**：假设响应变量受两个因子及其交互作用的影响。
2. **交互作用的检验**：首先检验两个因子之间是否存在交互作用。
3. **主效应的检验**：在没有显著交互作用的情况下，进一步检验各因子的主效应。

### 模型假设

假设响应变量 $Y_{ijk}$ 是独立的，并且服从正态分布：

$$
Y_{ijk} \sim N(\mu_{ij}, \sigma^2)
$$

均值模型如下：

$$
\mu_{ij} = \mu + \tau_i + \beta_j + \gamma_{ij}
$$

- **解释**：
  - $\mu$ 是总体均值。
  - $\tau_i $ 是因子 $T$ 在第 $ i $ 个水平上的效应。
  - $ \beta_j $ 是因子 $ B$ 在第 $j $ 个水平上的效应。
  - $\gamma_{ij} $ 是因子 $ T$ 和因子 $B$ 之间的交互作用效应。

### 假设检验

##### 1. 交互作用的检验

首先，我们需要检验因子 $T$ 和因子 $ B$ 之间是否存在交互作用：

- **零假设（$H_0$）**：所有交互作用效应 $ \gamma_{ij} = 0$
- **备择假设（$ H_1 $）**：至少有一个交互作用效应 $\gamma_{ij} \neq 0$

##### 2. 主效应的检验（在没有交互作用的情况下）

如果没有显著的交互作用效应（即交互作用效应不显著），我们可以进一步检验各因子的主效应：

- **因子 $ T $ 的效应**：
  
  - **零假设（$H_0 $）**：所有 $ T$ 因子的效应 $ \tau_i = 0 $
  - **备择假设（$ H_1 $）**：至少有一个 $ T $ 因子的效应 $ \tau_i \neq 0 $

- **因子 $ B $ 的效应**：
  
  - **零假设（$ H_0 $）**：所有 $ B $ 因子的效应 $ \beta_j = 0 $
  - **备择假设（$ H_1 $）**：至少有一个 $ B $ 因子的效应 $ \beta_j \neq 0 $

### 交互的意义

因子 $T$ 和 $B$ 之间的交互作用表示 $ T$ 的效应 取决于 $B$ 的水平，以及 $B$ 的效应取决于 $T$ 的水平。

如果在模型中有 $T$ 和 $B$ 两者之间的交互，那么我们无法解释任何一个因素的主要影响

在存在交互作用项的情况下，主效应不必显著

但是，主要效应必须保留在模型中，否则我们无法解释涉及该因子的任何交互作用项

### 例子：不同补充剂（OJ，VC）对豚鼠牙齿生长的影响

<img title="" src="file:///C:/Users/WIN10/Desktop/course/Note/imgs/pig1.png" alt="" data-align="center" width="282">

#### 图1：按补充剂类型和剂量划分的牙齿生长箱线图

这张图显示了不同补充剂类型（OJ和VC）和剂量（0.5、1.0和2.0毫克）组合下的牙齿长度分布。主要观察点包括：

- **补充剂类型OJ vs. VC:**
  
  - 在0.5毫克剂量下，OJ的牙齿长度中位数高于VC。
  - 在1.0毫克剂量下，OJ的牙齿长度中位数仍高于VC。
  - 在2.0毫克剂量下，VC的牙齿长度中位数高于OJ。

- **剂量效应:**
  
  - 对于OJ，牙齿长度随着剂量增加而增加。
  - 对于VC，牙齿长度在从1.0毫克增加到2.0毫克时显著增加，而从0.5毫克增加到1.0毫克时增加不那么显著。

这些模式表明，补充剂类型和剂量都对牙齿长度有影响，并且它们的效果可能是相互作用的。

<img title="" src="file:///C:/Users/WIN10/Desktop/course/Note/imgs/pig2.png" alt="" data-align="center" width="293">

#### 图2：补充剂类型和剂量的交互作用图

交互作用图显示了补充剂类型和剂量对牙齿长度的交互作用。每条线代表一个不同的剂量，点显示了在该剂量下每种补充剂类型的平均牙齿长度。主要观察点包括：

- **非平行线:** 不同剂量的线条不平行，表明补充剂类型和剂量之间存在显著的交互作用效应。
- **平均牙齿长度趋势:** 
  - 在0.5毫克剂量下，OJ的牙齿长度高于VC。
  - 在1.0毫克剂量下，OJ的牙齿长度仍高于VC。
  - 在2.0毫克剂量下，VC的牙齿长度高于OJ。

#### 在双因素ANOVA中的解释

双因素ANOVA评估两个独立变量（在本例中为补充剂类型和剂量）的主效应及其对一个依赖变量（牙齿长度）的交互作用效应。

- **主效应:** 
  
  - **补充剂类型:** OJ和VC之间的牙齿长度存在差异。
  - **剂量:** 随着剂量的增加，牙齿长度一般会增加，但不同补充剂的增加速率不同。

- **交互作用效应:** 一个独立变量（如补充剂类型）的效应取决于另一个独立变量（如剂量）的水平。交互作用图清晰地展示了这一点，因为补充剂类型对牙齿长度的影响随剂量的不同而变化。

总之，箱线图突出了不同条件下牙齿长度的分布和中心趋势，而交互作用图明确展示了补充剂类型和剂量之间的交互作用。两者结合表明，虽然补充剂类型和剂量都显著影响牙齿长度，但它们的效应并不是简单相加的，而是相互作用的。正如交互作用图中的非平行线所示，这种交互作用表明最佳的补充剂类型可能取决于剂量，这是理解和应用这些发现的重要见解。

#### 分析结果

**ANOVA Table**

| Variable  | Df  | Sum Sq | Mean Sq | F value | Pr(>F)   |
|:---------:|:---:|:------:|:-------:|:-------:|:--------:|
| supp      | 1   | 205.4  | 205.4   | 15.572  | 0.000231 |
| dose      | 1   | 2426.4 | 1213.2  | 92.000  | < 2e-16  |
| supp:dose | 2   | 108.3  | 54.2    | 4.107   | 0.021860 |
| Residuals | 54  | 712.1  | 13.2    |         |          |

其中 supp:dose 表示 补充剂类型（supp）和剂量（dose）的交互作用



设置一个参考组（OJ=0.05），我们可以看到通过线性估计的效果

$$
\begin{aligned}  
Tooth\ Length &= \beta_0 + \beta_1(VC) + \beta_2(Dose=1.0) + \beta_3(Dose=2.0) \\
               &\quad + \beta_4(VC:Dose=1.0) + \beta_5(VC:Dose=2.0) + \epsilon  
\end{aligned}
$$

**Estimated Table**

| Variable    | Estimate | Std. Error | t value | Pr(>\|t\|) |
|:-----------:|:--------:|:----------:|:-------:|:----------:|
| Ref(OJ:0.5) | 13.230   | 1.148      | 11.521  | 3.60e-16   |
| VC          | -5.250   | 1.624      | -3.233  | 0.00209    |
| 1.0         | 9.470    | 1.624      | 5.831   | 3.18e-07   |
| 2.0         | 12.830   | 1.624      | 7.900   | 1.43e-10   |
| VC:1.0      | -0.680   | 2.297      | -0.296  | 0.76831    |
| VC:2.0      | 5.330    | 2.297      | 2.321   | 0.02411    |

变量说明：

- 1.0（剂量1.0 mg）

- 2.0（剂量2.0 mg）

- VC:1.0（VC补充剂与1.0 mg剂量的交互作用）

- VC:2.0（VC补充剂与2.0 mg剂量的交互作用）

数据说明（结论）：

- Ref (OJ:0.5): 参考组的牙齿长度平均值为13.230。

- 与OJ相比，VC补充剂使牙齿长度减少了5.250（p < 0.05）。

- 与参考组（0.5 mg）相比，1.0 mg剂量使牙齿长度增加了9.470（p < 0.05）

- 与参考组（0.5 mg）相比，2.0 mg剂量使牙齿长度增加了12.830（p < 0.05）

- VC补充剂与1.0 mg剂量的交互作用对牙齿长度没有显著影响（p > 0.05）

- VC补充剂与2.0 mg剂量的交互作用使牙齿长度增加了5.330（p < 0.05）

- 每一行的 Estimate 分别对应于 $\beta_0 \cdots \beta_5 $ 

#### 事后检验

和单因素方差分析一样，进行所有可能的成对比较，如果这些因素之间存在交互作用，则必须在其他因素的水平内进行事后比较。
